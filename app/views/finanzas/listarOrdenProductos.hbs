<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
	<h1 class="page-header">Listado Orden Productos</h1>
	<div class="table-responsive">
		<table class="table table-striped">
			<thead>
				<tr>
					<th>Fecha Operacion</th>
					<th>Total Bruto</th>
					<th>IVA</th>
					<th>Total Neto</th>
					<th>Modificar</th>
					<th>Eliminar</th>
				</tr>
			</thead>
			<tbody>
				{{#each ordenes}}
					<tr>
						<td>{{orden.fechaOrden}}</td>
						<td>{{orden.totalBruto}}</td>
						<td>{{orden.iva}}</td>
						<td>{{orden.totalNeto}}</td>
						<td>
							<a href="#" class="modificar_orden_producto text-center" attr-id="{{_id}}"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a>
						</td>
						<td>
							<a href="#" class="eliminar_orden_producto text-center" attr-id="{{_id}}"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
						</td>
						
					</tr>
				{{/each}}
			</tbody>
		</table>
	</div>
</div>

<div id="contenedor_mod_orden" style="display:none">
	<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
		<h1 class="page-header">Modificar Orden de Productos</h1>
		<div class="row">
	        <div class="col-md-6">
	      		<h2>Datos Orden</h2>
				<form class="form-signin form-horizontal" action="ingresarOrden" method="post"  id="form_orden_producto">
					<input name="input_id_orden_producto" type="hidden" id="input_id_orden_producto">

					<label for="input_fecha_orden" class="control-label">Fecha Orden</label>
					<input name="fecha_orden" type="date" id="input_fecha_orden" class="form-control" required autofocus="">

					<label for="input_total_bruto" class="control-label">Total Bruto</label>
					<input name="fecha_orden" type="number" id="input_total_bruto" class="form-control" readonly autofocus="" value="0">
					
					<label for="input_iva" class="control-label">Total IVA</label>
					<input name="fecha_orden" type="number" id="input_iva" class="form-control" readonly autofocus="" value="0">

					<label for="input_total_neto" class="control-label">Total Neto</label>
					<input name="fecha_orden" type="number" id="input_total_neto" class="form-control" readonly autofocus="" value="0">

					<button class="btn btn-lg btn-primary btn-block" type="button" id="btn_modificar_orden">Modificar Orden Producto</button>
					
				</form>
	        </div>
	        <div class="col-md-6">
	          <h2>Datos Cliente</h2>
				<form name="datosCliente" class="form-signin" action="ingresarCliente" method="post" id="form_datos_cliente">
					<label for="input_nombre" class="control-label">Nombre Cliente</label>
					<input name="nombre" type="text" id="input_nombre" class="form-control"  required autofocus="">
				
					<label for="input_apellido" class="control-label">Apellido</label>
					<input name="apellido" type="text" id="input_apellido" class="form-control"   required autofocus="">
				
					<label for="input_direccion" class="control-label">Direccion</label>
					<input name="direccion" type="text" id="input_direccion" class="form-control"   autofocus="">
				
				
					<label for="input_teledono" class="control-label">Telefono</label>
					<input name="telefono" type="text" id="input_telefono" class="form-control"   autofocus="">
				
					<label for="input_ciudad" class="control-label">Ciudad</label>
					<input name="ciudad" type="text" id="input_ciudad" class="form-control"   autofocus="">
				
					<label for="input_region" class="control-label">Region</label>
					<input name="region" type="text" id="input_region" class="form-control"   autofocus="">
						
				</form>
	    	</div>
	   	</div>
	  	<div class="row">
	      		<div class="table-responsive">
	      			<h2>Productos en la orden
	      			<button type="button" class="btn btn-info btn-lg" id="btn_agragar_producto">
				  		<span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Agregar Producto
					</button>
					</h2>
					<table class="table table-striped" id="tabla_productos">
						<thead>
							<tr>
								<th>#</th>
								<th>Nombre</th>
								<th>Descripcion</th>
								<th>Precio</th>
								<th>cantidad</th>
								<th>Modificar</th>
								<th>Eliminar</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
		</div>
	</div>

<!-- MODAL PRODUCTOS -->
	<div class="modal fade" id="myModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Agregar Producto</h4>
				</div>
				<div class="modal-body">
					<form class="form-signin" action="ingresarProducto" method="post" id="form_producto">
						<label for="input_nombre_producto" class="control-label">Nombre Producto</label>
						<input name="nombre" type="text" id="input_nombre_producto" class="form-control"  required autofocus="">

						<label for="input_precio" class="control-label">Precio Producto</label>
						<input name="precio" type="text" id="input_precio" class="form-control" required autofocus="">

						<label for="input_descripcion" class="control-label">Descripcion Producto</label>
						<input name="descripcion" type="text" id="input_descripcion" class="form-control" autofocus="">

						<label for="input_cantidad" class="control-label">Cantidad Producto</label>
						<input name="cantidad" type="number" id="input_cantidad" class="form-control" required  autofocus="">

					</form>
					<span id='msjws' class='alert alert-info hide' ></span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
					<button type="button" class="btn btn-primary" id="guardar_producto">Agregar Producto a la orden</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="myModalMod">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Modificar Producto</h4>
				</div>
				<div class="modal-body">
					<form class="form-signin" action="ingresarProducto" method="post" id="form_producto_mod">
						<input name="id_prd_mod" type="hidden" id="id_prd_mod">

						<label for="input_nombre_producto" class="control-label">Nombre Producto</label>
						<input name="nombre" type="text" id="input_nombre_producto" class="form-control"  required autofocus="">

						<label for="input_precio" class="control-label">Precio Producto</label>
						<input name="precio" type="text" id="input_precio" class="form-control" required autofocus="">

						<label for="input_descripcion" class="control-label">Descripcion Producto</label>
						<input name="descripcion" type="text" id="input_descripcion" class="form-control" autofocus="">

						<label for="input_cantidad" class="control-label">Cantidad Producto</label>
						<input name="cantidad" type="number" id="input_cantidad" class="form-control" required  autofocus="">

					</form>
					<span id='msj_mod' class='alert alert-info hide' ></span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
					<button type="button" class="btn btn-primary" id="btn_modificar_prd">Modificar Producto a la orden</button>
				</div>
			</div>
		</div>
	</div>
		<div class="modal fade" id="modalResp">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Respuesta Modificacion Orden</h4>
				</div>
				<div class="modal-body">
					<div id='msj_mod_orden' class='alert alert-info'></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="../javascripts/ingreso_orden_producto.js"></script>
<script>
	$(document).ready(function(){
		var reload = false;
		$(".modificar_orden_producto").click(function(){
			var entrada = $(this).attr("attr-id");
			$.post("getOrdenProductoById", {id_orden_producto: entrada}, function(json){
				if(json!=null){
					console.log(json);
					$("#input_id_orden_producto").val(json._id);

					//datos orden
					var orden = json.orden;
					$("#input_fecha_orden")[0].value = orden.fechaOrden;
					$("#input_total_bruto").val(orden.totalBruto);
					$("#input_iva").val(orden.iva);
					$("#input_total_neto").val(orden.totalNeto);

					//Datos cliente
					var cliente = json.cliente;
					console.log(cliente);
					$("#input_nombre").val(cliente.nombre);
					$("#input_apellido").val(cliente.apellido);
					$("#input_direccion").val(cliente.direccion);
					$("#input_telefono").val(cliente.telefono);
					$("#input_ciudad").val(cliente.ciudad);
					$("#input_region").val(cliente.region);

					//productos
					var productos= json.productos;
					for (var i = 0; i < productos.length; i++) {
						console.log(productos[i]);
						listaProductos.cntProductos=listaProductos.cntProductos+1;
						agregar_producto_tabla(productos[i]);
					};

					$("#input_id_producto option[value="+ json.id_producto +"]").attr("selected",true);
					$("#input_cantidad").val(json.cantidad);
					
					$('#contenedor_mod_orden').slideToggle();
				}
			});
			
		});
		$("#btn_modificar_orden").click(function(){
			if($('#form_orden_producto')[0].checkValidity()){
				if($('#form_datos_cliente')[0].checkValidity()){
				actualizarOrden();

				console.log(listaProductos);
				console.log(datosOrden);
				datosCliente.nombre = $("#input_nombre").val();
				datosCliente.apellido = $("#input_apellido").val();
				datosCliente.direccion = $("#input_direccion").val();
				datosCliente.telefono = $("#input_telefono").val();
				datosCliente.ciudad = $("#input_ciudad").val();
				datosCliente.region = $("#input_region").val();
				console.log(datosCliente);
				var entrada = {};
				entrada = listaProductos;
				entrada.id_orden = $("#input_id_orden_producto").val();
				entrada.cliente = datosCliente;
				entrada.orden = datosOrden;

				console.log(JSON.stringify(entrada));

				var json = JSON.stringify(entrada);

				$.ajax({
					url:'modificarOrden',
				  	type: "post", //This sends in url
				  	data: {jsonParam: json}, //This will encode your json for url automatically
				  	dataType: "json", //With this the response will be automatically json-decoded!
				  	success: function(json){ //Assuming your server output was '{"lastName":"Villegas"}' as string
				  		console.log(json);
				  		if(json.codigo==1){
				  			$("#msj_mod_orden").text("Modificacion realizada correctamente");
				  			$('#modalResp').modal();
				  		}
				  	}
				});
				}else{
					var $myForm = $("#form_datos_cliente");
					$('<input type="submit">').hide().appendTo($myForm).click().remove();
				}
			}else{
				var $myForm = $("#form_orden_producto");
				$('<input type="submit">').hide().appendTo($myForm).click().remove();
			}
		});

		$('#modalResp').on('hide.bs.modal', function (e) {
			location.reload();
		});
		
		$(".eliminar_orden_producto").click(function(){
			var entrada = $(this).attr("attr-id");
			console.log(entrada);
			if(confirm("¿Esta seguro que desea eliminar esta orden producto?")){
				$.post("eliminarOrdenProductoById", {id_orden_producto: entrada}, function(json){
					location.reload();
				});
			}
			
		});
	});
</script>

<style>
	#myModal form input{
		margin-bottom:5px;
	}
	#myModal form select{
		margin-bottom:5px;
	}
	#msjws{
		display:block;
	}
</style>

<style>
	.table-responsive{
		margin-left: 10px;
		margin-right: 10px;
	}
	form input{
		margin-bottom:5px;
	}
</style>